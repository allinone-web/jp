# 部分魔法不能結算傷害 — 原因與伺服器權威說明

## 一、為什麼「部分魔法不能結算傷害」？

### 客戶端傷害結算的唯一來源

客戶端**只會在收到以下兩種封包時**做傷害結算（飄字、扣血）：

| 封包 | Opcode | 觸發 | 結算方式 |
|------|--------|------|----------|
| **S_ObjectAttackMagic（單體）** | 35 | `ObjectMagicDamage35`（magicFlag==6） | `HandleEntityAttackHit(targetId, damage)` |
| **S_ObjectAttackMagic（多目標）** | 57 | `ObjectMagicAttacked` 每個目標一筆 | 每個 `(targetId, damage)` 呼叫 `HandleEntityAttackHit` |

也就是說：**沒有 Op 35/57，就沒有傷害結算**。

### 伺服器端：誰會發、誰不會發傷害封包

- **會發** `S_ObjectAttackMagic`（Op 35 或 57）的，例如：
  - **EnergyBolt**（光箭等）：單體 → Op 35
  - **Lightning**（極光雷電等）：多目標 → Op 57
  - **ChillTouch / Freeze**：單體 → Op 35
  - **Light（日光術）**：已修復，發 Op 57（targetCount=0，僅地面特效）
- **不會發** 的，例如：
  - **Detection（技能 10 無所遁形術）**：只發 `S_ObjectAction(19)`、`S_ObjectEffect(castGfx)`，以及對隱身單位的 `S_ObjectInvis`，**完全不發** `S_ObjectAttackMagic`。
  - **BlessedArmor（技能 15 鎧甲護持）**：只發 `S_ObjectAction(19)`，成功時是道具 Buff，**不發** Op 35/57。

因此：

- **「部分魔法不能結算傷害」的直接原因**是：  
  該技能在伺服器實作裡**從來沒有送** `S_ObjectAttackMagic`（Op 35 或 57），客戶端收不到傷害資料，自然無法結算、也不該出現傷害飄字。

---

## 二、技能 10（無所遁形術）與 15（鎧甲護持）在伺服器做什麼？

### 技能 10 — Detection.java

- 協議：`C_Magic` 送 `(lv=2, no=4, id=目標)`，伺服器依 `(lv, no)` 找到技能 10，執行 `Detection.toMagic(id)`。
- 邏輯：對 `operator.getObjectList()` 內物件做「遭遇魔法」、解除隱身，並對隱身單位送 `S_ObjectInvis`。
- **沒有**計算傷害、**沒有**呼叫 `S_ObjectAttackMagic`，因此**不會**有 Op 35/57。

### 技能 15 — BlessedArmor.java

- 邏輯：對 `id`（道具欄位）的鎧甲上 Buff，送 `S_ObjectAction(19)` 與成功時的 `S_ObjectEffect`。
- **沒有**攻擊、**沒有** `S_ObjectAttackMagic`。

所以：  
伺服器對 10、15 的設計就是「非攻擊、無傷害封包」。客戶端若把這兩招當成「會打多目標的魔法」來播群體動畫，只是**顯示層的錯誤**，不影響伺服器邏輯，也**不會**因此多出傷害結算封包。

---

## 三、伺服器有「認可」客戶端動畫嗎？有漏洞嗎？

### 伺服器不認可、也不依賴客戶端動畫

- 伺服器只做三件事：
  1. 收 `C_Magic(lv, no, id)`
  2. 用 `(lv, no)` 決定技能、用 `id` 當目標/道具參數
  3. 執行該技能的 `toMagic(id)`，並依程式碼決定要送哪些封包（例如 Op 35/57、S_ObjectAction、S_ObjectEffect 等）

伺服器**不會**因為客戶端「播了單體還是群體動畫」而改變：
- 要結算的目標數量
- 要不要發傷害封包
- 傷害值與對象

因此：

- **「客戶端錯誤理解成群體魔法、或故意改成群體動畫」**：只影響客戶端自己的表現，**不影響**伺服器是否發送多目標/傷害。
- 對於 10、15，伺服器本來就不發 Op 35/57，所以**不存在**「伺服器認可了客戶端的群體傷害」或「多打多個目標」的漏洞。

### 若看到「每一個對方頭頂都有傷害結算飄字」

- 若是在**技能 10（無所遁形術）**下看到每個目標頭頂都有傷害飄字，依目前伺服器程式：
  - Detection **沒有**送任何傷害封包，理論上客戶端不應有「由 Op 35/57 觸發」的傷害飄字。
  - 可能情況包括：
    1. 實際施放的是**別招**（有發 Op 57 的範圍技），或  
    2. 客戶端用其他封包（例如 S_ObjectEffect、S_ObjectInvis）或本地邏輯錯誤地觸發了飄字。

若要確認，可對照封包：只有當**真的收到 Op 35 或 57** 且內容含該 targetId 與 damage 時，客戶端才應對該目標做傷害結算。

---

## 四、對齊結論（客戶端與伺服器）

| 問題 | 結論 |
|------|------|
| 為什麼部分魔法不能結算傷害？ | 該技能在伺服器**未發送** S_ObjectAttackMagic（Op 35/57），客戶端無從結算。 |
| 伺服器會因為客戶端播群體動畫就認可多目標傷害嗎？ | **不會**。目標與傷害完全由伺服器邏輯與封包決定。 |
| 技能 10 / 15 有送傷害封包嗎？ | **都沒有**。兩者皆非攻擊技，伺服器不發 Op 35/57。 |
| 是否存在「客戶端改群體就多結算傷害」的漏洞？ | **否**。多目標與傷害僅來自伺服器送出的 Op 35/57 內容，與客戶端動畫無關。 |

**Source of Truth**：`server/` 內各技能的 `toMagic()` 是否呼叫 `S_ObjectAttackMagic`，決定該技能在客戶端能否、以及如何結算傷害；客戶端只應依收到的 Op 35/57 如實結算，不應依「自以為的單體/群體」創造額外傷害。

---

## 五、補充：為何「無所遁形術」卻飄字、播 252、怪物會死？（已修復）

**原因**：客戶端 **C_MagicPacket** 原先用 `(skillId-1)/8` 與 `(skillId-1)%8` 計算 (lv, no)，而伺服器 **skill_list** 是**每級 5 格**（skill_level 1–10、skill_no 0–4）。  
因此 skillId=10 被送成 (lv=2, no=1)，伺服器對應到 **skill_id 7（寒冷戰慄）**，不是 skill_id 10（無所遁形術）。寒冷戰慄會發 Op 35、gfx=252、每目標傷害，所以會飄字、播 252、怪物會死。

**修復**：C_MagicPacket 改為與伺服器一致：`levelIdx = (skillId - 1) / 5`、`slotIdx = (skillId - 1) % 5`，寫入兩 byte；伺服器得到 lv = levelIdx+1、no = slotIdx，與 skill_list 的 skill_level / skill_no 對齊。修復後點「無所遁形術」會正確觸發 Detection，不再誤觸發寒冷戰慄。

---

## 六、補充：為何技能 16（燃燒的火球）先播放 171→218 卻沒有傷害結算？（已修復）

**原因**：客戶端對群體魔法（如技能 16）原先**對每個範圍內目標各發一包** C_Magic(skillId, t.ObjectId)。伺服器 **Lightning.toMagic(id)** 設計為：只接受**一個主目標 id**，依該目標位置算範圍內所有目標、傷害後回傳**一個** Op 57（多筆 targetId+damage）。  
發多包會導致：僅第一包觸發 toMagic 並回傳 Op 57，後續包被冷卻擋下；若冷卻未擋，則會重複傷害與重複 Op 57，與協議不符。且若第一包的主目標與玩家點選不一致，可能導致伺服器端 o==null 或範圍計算異常，Op 57 未正確送出或內容不符。

**修復**：群體魔法改為**只發一包** C_Magic(skillId, targetId)，targetId 為玩家點選的主目標（或當前攻擊目標）。與伺服器「一主目標、一 Op 57、多筆目標+傷害」對齊後，客戶端會收到一個 Op 57 並對每個目標正確結算傷害。
