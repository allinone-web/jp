using Godot;
using System;
using System.Collections.Generic;
using Skins.CustomFantasy;
using Client.Utility;
using System.Threading.Tasks; // å¼•å…¥å¼‚æ­¥åº“

namespace Client.Utility
{
	public partial class PakBrowser : Control
	{
		// ================================================================
		// é…ç½®è·¯å¾„
		// ================================================================
		private const string LIST_SPR_PATH = "res://Assets/list.spr";
		private static readonly string[] PAK_OPTIONS = new[] { "res://Assets/sprites-138.pak", "res://Assets/sprites-138-new2.pak" };
		// ================================================================
		// æ ¸å¿ƒç»„ä»¶
		// ================================================================
		private CustomCharacterProvider _provider;
		private AnimatedSprite2D _bodySprite;
		private AnimatedSprite2D _shadowSprite;
		private Label _infoLabel;
		private Label _loadingLabel; // åŠ è½½æç¤º
		private ItemList _gfxList;
		private GridContainer _actionGrid;
		private TextEdit _listSprText;
		
		// çŠ¶æ€æ•°æ®
		private int _currentGfxId = -1;
		private int _currentActionId = 0; // é»˜è®¤ Walk
		private int _currentHeading = 4;  // é»˜è®¤ å·¦ä¸‹
		private bool _isPlaying = true;
		private int _currentPakIndex = 0;   // 0 æˆ– 1 å°æ‡‰ PAK_OPTIONS
		private int _currentParamFilter = 0; // 0=all, 101,102,104,105,106,109 ç¯©é¸è§’è‰²åˆ—è¡¨

		// ================================================================
		// [æ ¸å¿ƒä¿®æ”¹] ä½¿ç”¨ async void _Ready å®ç°å¼‚æ­¥å¯åŠ¨
		// ================================================================
		public override async void _Ready()
		{
			GD.Print(">>> [PakBrowser] 1. å¯åŠ¨ç¨‹åº...");

			// 1. å…ˆæ„å»ºåŸºç¡€ UI (å…¨å±èƒŒæ™¯ + åŠ è½½æç¤º)
			// è¿™ä¸€æ­¥éå¸¸å¿«ï¼Œä¿è¯çª—å£ç¬é—´æœ‰å†…å®¹
			SetupBaseUI();

			// 2. ã€å…³é”®ã€‘å¼ºåˆ¶ç­‰å¾… 0.1 ç§’ï¼Œè®© Godot æ¸²æŸ“å‡ºä¸€å¸§ç”»é¢
			// è¿™æ ·ä½ å°±ä¸ä¼šåªçœ‹åˆ° Logo äº†ï¼Œè€Œæ˜¯çœ‹åˆ°æ·±çº¢è‰²çš„èƒŒæ™¯å’Œæ–‡å­—
			await ToSignal(GetTree().CreateTimer(0.1f), "timeout");

			GD.Print(">>> [PakBrowser] 2. å¼€å§‹åŠ è½½é‡å‹èµ„æº...");

			// 3. æ‰§è¡Œè€—æ—¶çš„åŠ è½½ä»»åŠ¡
			bool success = InitializeSystems();

			if (!success)
			{
				_loadingLabel.Text = "âŒ å¯åŠ¨å¤±è´¥ï¼\nè¯·æ£€æŸ¥ res://Assets/ ä¸‹æ˜¯å¦æœ‰ list.spr å’Œ sprites.pak\næŸ¥çœ‹ Output æ§åˆ¶å°è·å–è¯¦æƒ…ã€‚";
				_loadingLabel.Modulate = Colors.Red;
				return; // ç»ˆæ­¢
			}

			// 4. èµ„æºåŠ è½½æˆåŠŸï¼Œæ„å»ºå®Œæ•´åŠŸèƒ½ UI
			_loadingLabel.QueueFree(); // åˆ é™¤åŠ è½½æç¤º
			BuildMainUI();             // æ„å»ºä¸»ç•Œé¢
			RefreshGfxList();          // åˆ·æ–°æ•°æ®

			GD.Print(">>> [PakBrowser] 3. å°±ç»ªï¼");
		}

		private void SetupBaseUI()
		{
			// å¼ºåˆ¶å…¨å±
			this.SetAnchorsPreset(LayoutPreset.FullRect);
			this.Size = GetViewportRect().Size;

			// æ·±çº¢è‰²èƒŒæ™¯ (è°ƒè¯•ç”¨ï¼Œè¯æ˜ä»£ç è¿è¡Œäº†)
			var bg = new ColorRect();
			bg.Color = new Color(0.3f, 0.0f, 0.0f); 
			bg.SetAnchorsPreset(LayoutPreset.FullRect);
			AddChild(bg);

			// åŠ è½½æ–‡å­—
			_loadingLabel = new Label();
			_loadingLabel.Text = "æ­£åœ¨è¯»å– PAK å’Œ SPR æ–‡ä»¶...\nè¯·ç¨å€™...";
			_loadingLabel.Position = new Vector2(50, 50);
			_loadingLabel.Scale = new Vector2(2, 2);
			AddChild(_loadingLabel);
		}

		private bool InitializeSystems()
		{
			try
			{
				string listPath = ProjectSettings.GlobalizePath(LIST_SPR_PATH);
				string pakPath = ProjectSettings.GlobalizePath(PAK_OPTIONS[_currentPakIndex]);

				if (!System.IO.File.Exists(listPath))
				{
					GD.PrintErr($"[ç¼ºå¤±] List: {listPath}");
					return false;
				}
				if (!System.IO.File.Exists(pakPath))
				{
					GD.PrintErr($"[ç¼ºå¤±] Pak:  {pakPath}");
					return false;
				}

				ListSprLoader.Load(listPath);
				_provider = new CustomCharacterProvider(pakPath);
				return true;
			}
			catch (Exception e)
			{
				GD.PrintErr($"[å´©æºƒ] åˆå§‹åŒ–å¤±è´¥: {e}");
				return false;
			}
		}

		// ================================================================
		// UI æ„å»º
		// ================================================================
		// ã€ä¿®å¤ã€‘å‡½æ•°åä» BuildUI æ”¹ä¸º BuildMainUIï¼Œä»¥åŒ¹é…è°ƒç”¨
		private void BuildMainUI()
		{
			// èƒŒæ™¯æ¿
			var bg = new Panel();
			bg.SetAnchorsPreset(LayoutPreset.FullRect);
			AddChild(bg);

			// ä¸»åˆ†å‰²å®¹å™¨
			var mainSplit = new HSplitContainer();
			mainSplit.SetAnchorsPreset(LayoutPreset.FullRect);
			mainSplit.SplitOffset = 250; 
			AddChild(mainSplit);

			// --- å·¦ä¾§ï¼šè§’è‰²åˆ—è¡¨ ---
			var leftPanel = new VBoxContainer();
			// å·¦ä¾§åŠ ç‚¹è¾¹è·
			var marginContainer = new MarginContainer();
			marginContainer.AddThemeConstantOverride("margin_top", 10);
			marginContainer.AddThemeConstantOverride("margin_left", 10);
			marginContainer.AddThemeConstantOverride("margin_bottom", 10);
			marginContainer.SizeFlagsVertical = SizeFlags.ExpandFill;
			
			var leftVBox = new VBoxContainer();
			leftVBox.AddChild(new Label { Text = " è§’è‰²åˆ—è¡¨ (SprDefinition)" });
			
			_gfxList = new ItemList();
			_gfxList.SizeFlagsVertical = SizeFlags.ExpandFill;
			_gfxList.ItemSelected += OnGfxSelected;
			leftVBox.AddChild(_gfxList);
			
			marginContainer.AddChild(leftVBox);
			leftPanel.AddChild(marginContainer);
			leftPanel.SizeFlagsVertical = SizeFlags.ExpandFill; // ç¡®ä¿æ’‘å¼€
			
			mainSplit.AddChild(leftPanel);

			// --- å³å´ï¼šé è¦½+æ§åˆ¶+å‹•ä½œ | list.spr å®šç¾© ---
			var rightSplit = new HSplitContainer();
			rightSplit.SizeFlagsHorizontal = SizeFlags.ExpandFill;
			rightSplit.SplitOffset = 600;
			mainSplit.AddChild(rightSplit);

			var rightPanel = new VBoxContainer();
			rightPanel.SizeFlagsHorizontal = SizeFlags.ExpandFill;
			rightSplit.AddChild(rightPanel);

			// 1. é¡¶éƒ¨ï¼šé¢„è§ˆçª—å£
			var previewContainer = new Control();
			previewContainer.SizeFlagsVertical = SizeFlags.ExpandFill;
			previewContainer.SizeFlagsStretchRatio = 0.6f;
			previewContainer.CustomMinimumSize = new Vector2(0, 300);
			
			var previewBg = new ColorRect { Color = new Color(0.2f, 0.2f, 0.2f) };
			previewBg.SetAnchorsPreset(LayoutPreset.FullRect);
			previewContainer.AddChild(previewBg);
			
			// å–æ¶ˆåå­—ç·šï¼Œé¿å…å‹•ç•«åœ–åƒä¸Šç–Šä¸€å±¤ç™½è‰²
			var centerNode = new Control();
			centerNode.SetAnchorsPreset(LayoutPreset.Center);
			previewContainer.AddChild(centerNode);
			
			var charRoot = new Node2D { Scale = new Vector2(2, 2) }; 
			centerNode.AddChild(charRoot);

			_shadowSprite = new AnimatedSprite2D { Modulate = new Color(1, 1, 1, 0.5f) }; 
			charRoot.AddChild(_shadowSprite);
			
			_bodySprite = new AnimatedSprite2D();
			_bodySprite.FrameChanged += OnFrameChanged;
			charRoot.AddChild(_bodySprite);

			// ä¿¡æ¯æ ‡ç­¾ (æ”¾åˆ°å·¦ä¸Šè§’)
			_infoLabel = new Label();
			_infoLabel.Position = new Vector2(10, 10);
			previewContainer.AddChild(_infoLabel);

			rightPanel.AddChild(previewContainer);

			// 2. æ§åˆ¶æ 
			var controlBar = new HBoxContainer();
			controlBar.Alignment = BoxContainer.AlignmentMode.Center;
			controlBar.AddChild(CreateBtn("â®", () => { _bodySprite.Frame = 0; }));
			controlBar.AddChild(CreateBtn("â¯ æ’­æ”¾/æš‚åœ", TogglePlay));
			controlBar.AddChild(CreateBtn("â­ å•å¸§", NextFrame));
			controlBar.AddChild(new VSeparator());
			for(int i=0; i<8; i++) {
				int h = i;
				controlBar.AddChild(CreateBtn(h.ToString(), () => ChangeHeading(h)));
			}
			rightPanel.AddChild(controlBar);

			// 3. åº•éƒ¨ï¼šè§’è‰²å‹•ä½œå€ (SprActionSequence)
			var actionLabel = new Label { Text = " è§’è‰²å‹•ä½œå€ (SprActionSequence) â€” é¸å‹•ä½œå¾Œæ’­æ”¾" };
			rightPanel.AddChild(actionLabel);
			var scrollAction = new ScrollContainer();
			scrollAction.SizeFlagsVertical = SizeFlags.ExpandFill;
			scrollAction.SizeFlagsStretchRatio = 0.4f;
			
			_actionGrid = new GridContainer();
			_actionGrid.Columns = 8;
			_actionGrid.SizeFlagsHorizontal = SizeFlags.ExpandFill;
			scrollAction.AddChild(_actionGrid);
			
			rightPanel.AddChild(scrollAction);

			// 4. å³é‚Šç¬¬ 4 å€ï¼šlist.spr å®šç¾©ï¼ˆå°æ‡‰è§’è‰²çš„ list.spr å…§å®¹ï¼‰
			var listSprPanel = new VBoxContainer();
			listSprPanel.SizeFlagsHorizontal = SizeFlags.ExpandFill;
			listSprPanel.CustomMinimumSize = new Vector2(280, 0);
			listSprPanel.AddChild(new Label { Text = " list.spr å®šç¾© (å°æ‡‰è§’è‰²)" });
			var listSprScroll = new ScrollContainer();
			listSprScroll.SizeFlagsVertical = SizeFlags.ExpandFill;
			_listSprText = new TextEdit();
			_listSprText.Editable = false;
			_listSprText.WrapMode = TextEdit.LineWrappingMode.Boundary;
			_listSprText.SizeFlagsHorizontal = SizeFlags.ExpandFill;
			_listSprText.SizeFlagsVertical = SizeFlags.ExpandFill;
			listSprScroll.AddChild(_listSprText);
			listSprPanel.AddChild(listSprScroll);

			// 4. PAK é¸æ“‡å€ï¼ˆå…§ç½® 2 å€‹é‚è¼¯ï¼‰
			listSprPanel.AddChild(new Label { Text = " 4. PAK é¸æ“‡å€" });
			var pakRow = new HBoxContainer();
			for (int i = 0; i < PAK_OPTIONS.Length; i++)
			{
				string name = System.IO.Path.GetFileName(PAK_OPTIONS[i]);
				var btn = new Button { Text = name };
				int idx = i;
				btn.Pressed += () => OnPakSelected(idx);
				if (i == _currentPakIndex) btn.Modulate = new Color(0.6f, 1f, 0.6f);
				pakRow.AddChild(btn);
			}
			listSprPanel.AddChild(pakRow);

			// 5. ç‰¹åˆ¥åƒæ•¸é¸æ“‡å€ï¼ˆall + 101,102,104,105,106,109ï¼‰é—œè¯è§’è‰²åˆ—è¡¨ç¯©é¸
			listSprPanel.AddChild(new Label { Text = " 5. ç‰¹åˆ¥åƒæ•¸é¸æ“‡å€ï¼ˆç¯©é¸è§’è‰²åˆ—è¡¨ï¼‰" });
			var paramRow = new HBoxContainer();
			var paramIds = new[] { 0, 101, 102, 104, 105, 106, 109 }; // 0 = all
			foreach (int pid in paramIds)
			{
				string label = pid == 0 ? "all" : pid.ToString();
				var btn = new Button { Text = label };
				int p = pid;
				btn.Pressed += () => OnParamFilterSelected(p);
				if (p == _currentParamFilter) btn.Modulate = new Color(0.6f, 1f, 0.6f);
				paramRow.AddChild(btn);
			}
			listSprPanel.AddChild(paramRow);

			rightSplit.AddChild(listSprPanel);
		}

		// ================================================================
		// é€»è¾‘æ§åˆ¶
		// ================================================================
		private void RefreshGfxList()
		{
			_gfxList.Clear();
			var ids = ListSprLoader.GetAllGfxIds();
			ids.Sort();
			foreach (var id in ids)
			{
				var def = ListSprLoader.Get(id);
				if (def == null) continue;
				// ç‰¹åˆ¥åƒæ•¸ç¯©é¸ï¼š0=allï¼Œå¦å‰‡åªé¡¯ç¤ºæœ‰è©²å…ƒæ•¸æ“š ID çš„ SprDefinition
				if (_currentParamFilter != 0 && !def.ParsedMetadataIds.Contains(_currentParamFilter))
					continue;
				string name = def.Name ?? "Unknown";
				_gfxList.AddItem($"#{id} - {name}");
				_gfxList.SetItemMetadata(_gfxList.ItemCount - 1, id);
			}
			GD.Print($"[PakBrowser] è§’è‰²åˆ—è¡¨ (SprDefinition) å…± {_gfxList.ItemCount} å€‹ (ç¯©é¸={_currentParamFilter})");
		}

		private void OnPakSelected(int index)
		{
			if (index == _currentPakIndex) return;
			_currentPakIndex = index;
			string pakPath = ProjectSettings.GlobalizePath(PAK_OPTIONS[_currentPakIndex]);
			if (!System.IO.File.Exists(pakPath))
			{
				GD.PrintErr($"[PakBrowser] æ‰¾ä¸åˆ° PAK: {pakPath}");
				return;
			}
			_provider = new CustomCharacterProvider(pakPath);
			RefreshGfxList();
			RefreshActionButtons();
			RefreshListSprContent();
			PlayAnimation();
		}

		private void OnParamFilterSelected(int paramId)
		{
			if (paramId == _currentParamFilter) return;
			_currentParamFilter = paramId;
			RefreshGfxList();
		}

		private void OnGfxSelected(long index)
		{
			_currentGfxId = (int)_gfxList.GetItemMetadata((int)index);
			RefreshActionButtons();
			RefreshListSprContent();
			PlayAnimation();
		}

		private void RefreshListSprContent()
		{
			if (_listSprText == null) return;
			string path = ProjectSettings.GlobalizePath(LIST_SPR_PATH);
			_listSprText.Text = GetListSprBlock(path, _currentGfxId);
		}

		/// <summary>å¾ list.spr è®€å–å°æ‡‰ GfxId çš„å®šç¾©å€å¡Šï¼ˆ#id é–‹é ­åˆ°ä¸‹ä¸€ # æˆ–æª”æ¡ˆçµå°¾ï¼‰</summary>
		private static string GetListSprBlock(string listSprPath, int gfxId)
		{
			if (gfxId < 0 || !System.IO.File.Exists(listSprPath)) return "";
			string prefix = "#" + gfxId.ToString();
			var lines = new List<string>();
			bool inBlock = false;
			foreach (string line in System.IO.File.ReadAllLines(listSprPath))
			{
				string trimmed = line.Trim();
				if (string.IsNullOrEmpty(trimmed) || trimmed.StartsWith("//")) continue;
				if (trimmed.StartsWith("#"))
				{
					if (trimmed.StartsWith(prefix) && (trimmed.Length == prefix.Length || trimmed[prefix.Length] == ' ' || trimmed[prefix.Length] == '\t'))
					{
						inBlock = true;
						lines.Add(line);
					}
					else
						inBlock = false;
					continue;
				}
				if (inBlock) lines.Add(line);
			}
			return string.Join("\n", lines);
		}

		private void RefreshActionButtons()
		{
			foreach (var c in _actionGrid.GetChildren()) c.QueueFree();

			var def = ListSprLoader.Get(_currentGfxId);
			if (def == null) return;

			// æ ¹æ“š SprActionSequence åˆ—å‡ºè©²è§’è‰²æ‰€æœ‰å‹•ä½œ (def.Actions)
			var actionIds = new List<int>(def.Actions.Keys);
			actionIds.Sort();
			foreach (int actId in actionIds)
			{
				var seq = def.Actions[actId];
				string btnName = $"{actId}.{seq?.Name ?? ""}";
				var btn = new Button { Text = btnName };
				btn.Modulate = new Color(0.5f, 1f, 0.5f);
				int a = actId;
				btn.Pressed += () => ChangeAction(a);
				_actionGrid.AddChild(btn);
			}
		}

		private void ChangeAction(int actionId)
		{
			_currentActionId = actionId;
			PlayAnimation();
		}

		private void ChangeHeading(int h)
		{
			_currentHeading = h;
			PlayAnimation();
		}

		private void PlayAnimation()
		{
			if (_currentGfxId < 0 || _provider == null) return;

			try 
			{
				var def = ListSprLoader.Get(_currentGfxId);
				var bodyFrames = _provider.GetBodyFrames(_currentGfxId, _currentActionId, _currentHeading);
				
				if (bodyFrames != null)
				{
					_bodySprite.SpriteFrames = bodyFrames;
					// å‹•ç•«åï¼šä¾ SprActionSequence.DirectionFlagï¼Œç„¡å‘ç”¨ "0"ï¼Œæœ‰å‘ç”¨ heading
					var seq = ListSprLoader.GetActionSequence(def, _currentActionId);
					string animName = (seq != null && seq.DirectionFlag == 0) ? "0" : _currentHeading.ToString();
					if (bodyFrames.HasAnimation(animName))
						_bodySprite.Play(animName);
					else
					{
						var names = bodyFrames.GetAnimationNames();
						if (names != null && names.Length > 0)
							_bodySprite.Play(names[0]);
					}
					_bodySprite.SpeedScale = _isPlaying ? 1.0f : 0.0f;
				}
				else
				{
					_bodySprite.SpriteFrames = null;
				}

				// é™°å½±
				if (def != null && def.ShadowId > 0)
				{
					var shadowFrames = _provider.GetBodyFrames(def.ShadowId, 0, _currentHeading);
					if (shadowFrames != null)
					{
						_shadowSprite.SpriteFrames = shadowFrames;
						_shadowSprite.Play(_currentHeading.ToString());
						_shadowSprite.SpeedScale = _isPlaying ? 1.0f : 0.0f;
						_shadowSprite.Visible = true;
					}
					else _shadowSprite.Visible = false;
				}
				else _shadowSprite.Visible = false;

				UpdateInfoLabel();
			}
			catch(Exception e)
			{
				GD.PrintErr($"æ’­æ”¾åŠ¨ç”»å‡ºé”™: {e.Message}");
			}
		}

		private void UpdateInfoLabel()
		{
			var def = ListSprLoader.Get(_currentGfxId);
			var seq = ListSprLoader.GetActionSequence(def, _currentActionId);
			string actName = seq?.Name ?? "-";
			int frameCount = seq?.Frames?.Count ?? 0;
			_infoLabel.Text = $" Gfx: {_currentGfxId}\n Act: {_currentActionId} ({actName})\n Dir: {_currentHeading}\n å¹€æ•¸ (SprFrame): {frameCount}";
		}

		private void TogglePlay()
		{
			_isPlaying = !_isPlaying;
			if (_bodySprite.SpriteFrames != null) _bodySprite.SpeedScale = _isPlaying ? 1.0f : 0.0f;
			if (_shadowSprite.SpriteFrames != null) _shadowSprite.SpeedScale = _isPlaying ? 1.0f : 0.0f;
		}

		private void NextFrame()
		{
			_isPlaying = false;
			if (_bodySprite.SpriteFrames != null)
			{
				_bodySprite.SpeedScale = 0;
				int f = _bodySprite.Frame;
				int count = _bodySprite.SpriteFrames.GetFrameCount(_bodySprite.Animation);
				if (count > 0) _bodySprite.Frame = (f + 1) % count;
			}
			if (_shadowSprite.SpriteFrames != null)
			{
				_shadowSprite.SpeedScale = 0;
				if (_shadowSprite.SpriteFrames.HasAnimation(_shadowSprite.Animation))
				{
					int f = _bodySprite.Frame;
					int count = _shadowSprite.SpriteFrames.GetFrameCount(_shadowSprite.Animation);
					if (count > 0) _shadowSprite.Frame = f % count;
				}
			}
		}

		private void OnFrameChanged()
		{
			if (_bodySprite.SpriteFrames == null) return;

			// é˜´å½±åŒæ­¥
			if (_shadowSprite.Visible && _shadowSprite.SpriteFrames != null)
			{
				 if (_shadowSprite.SpriteFrames.HasAnimation(_shadowSprite.Animation))
				 {
					int count = _shadowSprite.SpriteFrames.GetFrameCount(_shadowSprite.Animation);
					if (count > 0) _shadowSprite.Frame = _bodySprite.Frame % count;
				 }
			}

			// å£°éŸ³è°ƒè¯•
			var tex = _bodySprite.SpriteFrames.GetFrameTexture(_bodySprite.Animation, _bodySprite.Frame);
			if (tex != null && tex.HasMeta("spr_sound_ids"))
			{
				var sounds = (Godot.Collections.Array<int>)tex.GetMeta("spr_sound_ids");
				foreach(int sid in sounds)
				{
					GD.Print($"[Audio] ğŸ”Š æ’­æ”¾éŸ³æ•ˆ ID: {sid}");
				}
			}
		}

		private Button CreateBtn(string text, Action onPress)
		{
			var b = new Button { Text = text };
			b.Pressed += onPress;
			return b;
		}
	}
}
