# 玩家移動速度計算

## 1. 移動速度數據來源

### 1.1 服務器數據庫

**數據來源**：`server/datebase_182_2026-01-21.sql` → `SprDataTable.cs`

**移動動作（action=0）的 `frame` 值**（單位：**毫秒**）：

| GfxId | 角色類型 | 移動間隔（毫秒） | 移動間隔（秒） |
|-------|---------|----------------|---------------|
| 0, 1 | 王族（男/女） | 640 | 0.64 |
| 37, 48, 61 | 精靈、騎士（男/女） | 640 | 0.64 |
| 138 | 精靈（男） | 640 | 0.64 |
| 734, 1186 | 法師（男/女） | 640 | 0.64 |
| 30 | 特殊角色 | 640 | 0.64 |
| 53, 95, 96, 1104 | 特殊角色 | 480 | 0.48 |
| 54 | 特殊角色 | 560 | 0.56 |
| 56 | 特殊角色 | 800 | 0.80 |
| 29, 32, 1020, 1098 | 特殊角色 | 960 | 0.96 |
| 49, 1059 | 特殊角色 | 1280 | 1.28 |
| 52 | 特殊角色 | 1640 | 1.64 |
| 945 | 特殊角色 | 1920 | 1.92 |

### 1.2 客戶端計算

**客戶端代碼** (`Client/Game/GameWorld.Movement.cs:28`):
```csharp
float baseInterval = SprDataTable.GetInterval(ActionType.Move, _myPlayer.GfxId, 0) / 1000.0f;
```

**關鍵點**：
- `SprDataTable.GetInterval` 返回的是**毫秒數**
- 除以 1000.0f 轉換為**秒數**

## 2. 移動一個格子（32像素）的時間

### 2.1 標準角色

**大部分角色（GfxId = 0, 1, 37, 48, 61, 138, 734, 1186 等）**：
- **移動間隔**：640 毫秒 = **0.64 秒**
- **移動距離**：32 像素（1個地圖格子）

**計算結果**：
- **移動一個格子需要 640 毫秒（0.64 秒）**

### 2.2 特殊角色

| 角色類型 | 移動間隔（毫秒） | 移動一個格子時間 |
|---------|----------------|----------------|
| 標準角色（大部分） | 640 | 640 毫秒（0.64 秒） |
| 快速角色（53, 95, 96, 1104） | 480 | 480 毫秒（0.48 秒） |
| 中速角色（54） | 560 | 560 毫秒（0.56 秒） |
| 慢速角色（56） | 800 | 800 毫秒（0.80 秒） |
| 更慢角色（29, 32, 1020, 1098） | 960 | 960 毫秒（0.96 秒） |
| 很慢角色（49, 1059） | 1280 | 1280 毫秒（1.28 秒） |
| 極慢角色（52） | 1640 | 1640 毫秒（1.64 秒） |
| 最慢角色（945） | 1920 | 1920 毫秒（1.92 秒） |

## 3. 加速/緩速效果

### 3.1 加速效果（Haste/綠水）

**服務器邏輯** (`server/check/CheckSpeed.java:96-98`):
```java
if (this._pc.isSpeed()) {
  interval = (int)(interval * 0.75D);  // 縮短到 75%
}
```

**客戶端邏輯** (`Client/Game/GameWorld.Movement.cs:34-37`):
```csharp
if (_myPlayer.AnimationSpeed > 1.0f) 
{
    _moveInterval *= 0.75f;  // 縮短到 75%
}
```

**計算結果**：
- **標準角色（640ms）**：640 × 0.75 = **480 毫秒（0.48 秒）**
- **快速角色（480ms）**：480 × 0.75 = **360 毫秒（0.36 秒）**

### 3.2 緩速效果（Slow）

**服務器邏輯** (`server/check/CheckSpeed.java:100-102`):
```java
if (this._pc.isSlow()) {
  interval = (int)(interval / 0.75D);  // 延長到 133.33%
}
```

**客戶端邏輯** (`Client/Game/GameWorld.Movement.cs:39-42`):
```csharp
else if (_myPlayer.AnimationSpeed < 1.0f)
{
    _moveInterval /= 0.75f;  // 延長到 133.33%
}
```

**計算結果**：
- **標準角色（640ms）**：640 / 0.75 = **853.33 毫秒（0.853 秒）**

## 4. 總結

### 4.1 標準角色移動時間

**無加速/緩速**：
- **移動一個格子（32像素）需要 640 毫秒（0.64 秒）**

**加速（Haste）**：
- **移動一個格子需要 480 毫秒（0.48 秒）**

**緩速（Slow）**：
- **移動一個格子需要 853.33 毫秒（0.853 秒）**

### 4.2 與怪物移動對比

| 實體類型 | 移動間隔 | 移動一個格子時間 |
|---------|---------|----------------|
| **玩家（標準）** | 640ms | **640 毫秒** |
| **玩家（加速）** | 480ms | **480 毫秒** |
| **玩家（緩速）** | 853ms | **853 毫秒** |
| **怪物** | 400-800ms | **400-800 毫秒**（根據怪物類型） |

### 4.3 關鍵發現

1. **玩家移動速度**：標準 640 毫秒/格，與大部分怪物（400-800ms）相近
2. **移動包發送頻率**：
   - **玩家移動**：每 640 毫秒一次（標準）
   - **怪物移動**：每 400-800 毫秒一次
3. **問題分析**：
   - 如果玩家在 640 毫秒內移動了，但怪物在 400-800 毫秒內也移動了
   - 客戶端可能還沒收到怪物的移動包，就發送了攻擊包
   - 導致使用過時的目標座標，服務器判定攻擊miss

### 4.4 解決方案

**在發送攻擊包前，重新從 `_entities` 獲取目標的最新座標**，確保使用服務器最新確認的座標。
